---
import { Icon } from 'react-iconify-icon-wrapper'
import matter from 'gray-matter'
import { getContentsgarten } from '$functions/getContentsgarten'
import { parseFrontMatter } from '$functions/parseFrontMatter'

export interface Props {
  username: string
  success?: boolean
  error?: string
}

const { username, success = false, error = '' } = Astro.props
let profileData = {
  name: '',
  intro: '',
  nickname: '',
  nicknameTh: ''
}

// Get wiki profile data for the user
if (username) {
  try {
    const wiki = getContentsgarten(Astro)
    const wikiPage = await wiki.search.query({
      pageRef: [`People/${username}`],
    })
    const result = wikiPage.results[0]?.frontMatter
    const parsed = parseFrontMatter(result)
    if (parsed.success && parsed.data.person) {
      profileData = {
        name: parsed.data.person.name || '',
        intro: parsed.data.person.intro || '',
        nickname: parsed.data.person.nickname || '',
        nicknameTh: parsed.data.person.nicknameTh || ''
      }
    }
  } catch (error) {
    console.error('Error fetching profile data:', error)
  }
}
---

<h2 class="mb-4 text-lg font-medium">Public Profile</h2>

<p class="text-neutral-700 mb-4">
  Update your public profile information that appears on your wiki page.
</p>

{success && (
  <div class="mb-4 rounded-md bg-green-50 p-4">
    <div class="flex">
      <div class="flex-shrink-0 text-green-400">
        <Icon icon="heroicons:check-circle" className="h-5 w-5" />
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-green-800">Profile Updated</h3>
        <div class="mt-2 text-sm text-green-700">
          <p>Your profile has been successfully updated.</p>
        </div>
      </div>
    </div>
  </div>
)}

{error && (
  <div class="mb-4 rounded-md bg-red-50 p-4">
    <div class="flex">
      <div class="flex-shrink-0 text-red-400">
        <Icon icon="heroicons:x-circle" className="h-5 w-5" />
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-red-800">Error</h3>
        <div class="mt-2 text-sm text-red-700">
          <p>{error}</p>
        </div>
      </div>
    </div>
  </div>
)}

<form action="/dashboard/profile/update" method="POST" class="space-y-4">
  <div>
    <label for="name" class="block text-sm font-medium text-gray-700">
      Full Name
    </label>
    <input
      type="text"
      id="name"
      name="name"
      value={profileData.name}
      class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
      placeholder="Your full name"
    />
  </div>

  <div>
    <label for="intro" class="block text-sm font-medium text-gray-700">
      Introduction
    </label>
    <textarea
      id="intro"
      name="intro"
      rows={3}
      class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
      placeholder="Brief introduction or bio"
    >{profileData.intro}</textarea>
  </div>

  <div>
    <label for="nickname" class="block text-sm font-medium text-gray-700">
      Nickname (English)
    </label>
    <input
      type="text"
      id="nickname"
      name="nickname"
      value={profileData.nickname}
      class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
      placeholder="Your English nickname"
    />
  </div>

  <div>
    <label for="nicknameTh" class="block text-sm font-medium text-gray-700">
      Nickname (Thai)
    </label>
    <input
      type="text"
      id="nicknameTh"
      name="nicknameTh"
      value={profileData.nicknameTh}
      class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
      placeholder="ชื่อเล่นภาษาไทย"
    />
  </div>

  <div class="rounded-md bg-blue-50 p-4">
    <div class="flex">
      <div class="flex-shrink-0 text-blue-400">
        <Icon icon="heroicons:information-circle" className="h-5 w-5" />
      </div>
      <div class="ml-3">
        <p class="text-sm text-blue-700">
          These profile details will be visible on your public wiki page at{' '}
          <a
            href={`/wiki/People/${username}`}
            class="font-medium text-blue-700 underline"
            target="_blank"
            rel="noopener noreferrer"
          >
            /wiki/People/{username}
          </a>
        </p>
      </div>
    </div>
  </div>

  <div class="pt-2">
    <button
      type="submit"
      class="inline-flex items-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:outline-none"
    >
      Save Profile
    </button>
  </div>
</form> 