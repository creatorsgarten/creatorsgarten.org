---
import { UsernameFormWrapper as UsernameForm } from '$components/auth/usernameForm'
import Breadcrumb from '$components/breadcrumb.astro'
import { QueryClientContextProvider } from '$constants/queryClient'
import BaseLayout from '$layouts/base.astro'

// Redirect if not authenticated
if (!Astro.locals.user) {
  return Astro.redirect('/auth')
}

const user = await Astro.locals.user
const hasGithubConnection = Boolean(user?.connections?.github)

const onReserveUsername = async (username: string) => {
  try {
    const result = await Astro.locals.backend.auth.reserveUsername.mutate({
      username,
    })

    // Refresh cookies with new token
    if (result.idToken) {
      Astro.cookies.set('authgarten', result.idToken, {
        maxAge: 60 * 60 * 12, // 12 hours
        httpOnly: true,
        secure: import.meta.env.PROD,
        path: '/',
        sameSite: 'lax',
      })
    }

    return result
  } catch (error) {
    console.error('Error reserving username:', error)
    throw error
  }
}
---

<BaseLayout title="Username Management">
  <Breadcrumb
    items={[
      { label: 'Dashboard', href: '/dashboard' },
      { label: 'Profile', href: '/dashboard/profile' },
      { label: 'Username', href: '/dashboard/profile/username' },
    ]}
  />

  <h1 class="mb-6 text-3xl font-bold">Username Management</h1>

  <div class="mb-8">
    <p class="mb-2 text-gray-700">
      Your username is a unique identifier that will be used for your public
      profile and Wiki page.
    </p>
    <p class="mb-4 text-gray-700">
      Once reserved, your username cannot be changed and will be used for your
      Wiki page at <code>People/[username]</code>.
    </p>
  </div>

  <div class="space-y-6">
    <QueryClientContextProvider client:load>
      <UsernameForm
        client:load
        initialUsername={user.username}
        hasGithub={hasGithubConnection}
        onReserve={onReserveUsername}
      />
    </QueryClientContextProvider>

    {
      user.username && (
        <div class="bg-white p-6 shadow sm:rounded-lg">
          <h2 class="mb-4 text-lg font-semibold">Your Profile Page</h2>
          <p class="mb-4">
            Your public profile is available at the following location:
          </p>
          <div class="rounded-md bg-gray-50 p-3">
            <p class="font-mono break-all">
              <a
                href={`/wiki/People/${user.username}`}
                class="text-blue-600 hover:underline"
              >
                /wiki/People/{user.username}
              </a>
            </p>
          </div>
        </div>
      )
    }
  </div>
</BaseLayout>
